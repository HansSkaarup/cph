<!DOCTYPE html>
<html>
<head>
    <meta charset= "utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Semester 1 Group Project</title>
    <!--Leaflet-->
    <!--include leaflet CSS-->
    <link rel="stylesheet" href="lib/leaflet/leaflet.css"/>
    <script src="jquery/jquery-3.1.1.min.js"></script>
    <!--include leaflet javascript file-->
    <script src="lib/leaflet/leaflet.js"></script>
    <script>// type="text/javascript" src="dist/leaflet.ajax.js"></script>
    <!--include awesome markers-->
    <link rel="stylesheet" href="lib/Awesome-markers/dist/leaflet.awesome-markers.css">
    <script src="lib/Awesome-markers/dist/leaflet.awesome-markers.js"></script>
    <!--include sidebar files-->
    <script src="https://use.fontawesome.com/fea527cdc3.js"></script>
    <link rel="stylesheet" href="lib/sidebar-v2-master/css/leaflet-sidebar.css" />
    <script type="text/javascript" src="lib/sidebar-v2-master/js/leaflet-sidebar.js"></script>
    <!--Load Dawa autocomplete-->
    <link rel="stylesheet" href="lib/jquery-ui/themes/start/jquery-ui.css">
    <link rel="stylesheet" href="lib/jquery-ui/themes/start/theme.css">
    <script src="lib/jquery-ui/jquery-ui.js"></script>
    <script src="lib/autocomplete-0.4.1/dawa-autocomplete.js"></script>
    <!---graph-->
    <script src="lib/canvasjs.min.js"></script>
    <!--include geoJson file-->
    <style type="text/css">
        <!--to get a full screen map-->
        body {
            padding: 0;
            margin: 0;
        }
        html, body,#mapid{
            height:100%;
            width:100%;
        }

        .ui-front {z-index: 9999999 !important;  }

    </style>
</head>
<body>

<div id="sidebar" class="sidebar collapsed">
    <!-- Nav tabs -->
    <div class="sidebar-tabs">
        <ul role="tablist">
            <li><a href="#home" role="tab"><i class="fa fa-search"></i></a></li>
            <li><a href="#ageStructure" role="tab"><i class="fa fa-bar-chart"></i></a></li>
            <li><a href="#parks" role="tab"><i class="fa fa-leaf"></i></a></li>
            <li><a href="#transit" role="tab"><i class="fa fa-train"></i></a></li>
            <li><a href="https://github.com/hansskaarup/cph" role="tab" target="_blank"><i class="fa fa-github"></i></a></li>
        </ul>

        <ul role="tablist">
            <li class="disabled"><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
        </ul>
    </div>

    <!-- Tab panes -->
    <div class="sidebar-content">
        <div class="sidebar-pane" id="home">
            <h1 class="sidebar-header">
                search address
                <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
            </h1>

            <p>Enter an address in Copenhagen to get an analysis of the location:</p>

            <!-- Autocomplete adress search line -->
            <p><label for="adgangsadresse-autocomplete"></label></p>
            <input type="text" id="adgangsadresse-autocomplete" style="width: 400px;">

            <button type="button" onclick=sqlfunction()><b>GO!</b></button>


            <p id="showdata"></p>
            <p class="lorem">This is a web GIS application which uses the address you enter above and analyses it according to various geographic characteristics.</p>
            <p class="lorem">In the initial stage, we use proximity to parks and green spaces as one variable, the age structure of the city block as another, and the nearest train station as the third.</p>
            <p class="lorem">These variables represent three different types of data: distance to amenities (vector polygons), area characteristics (raster) and nearest station (vector point).</p>
            <p class="lorem">In the future more datasets will be added to expand the information available and network analysis will be used to improve the accuracy.</p>


        </div>

        <div class="sidebar-pane" id="ageStructure">
            <div id="chartContainer" style="position: absolute; padding-top: 50px"></div>
            <h1 class="sidebar-header">age structure<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            <div id="chartContainer2" style=" padding-top: 450px"></div>
            <p class="lorem" style="font-size:12px; margin-top:450px;">Data sourced from Københavns Kommune GIS department</p>
        </div>

        <div class="sidebar-pane" id="parks">
            <h1 class="sidebar-header">green spaces nearby<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            <p id="showdata3"></p>
            <p class="lorem" style="font-size:12px; margin-top:400px;">Data sourced from DAWA & Copenhagen Data</p>
        </div>
        <div class="sidebar-pane" id="transit">
            <h1 class="sidebar-header">transit nearby<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

            <p id="showdata4"></p>
            <p id="showdata5"></p>

        </div>

        <div class="sidebar-pane" id="settings">
            <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
        </div>
    </div>
</div>

<!--div element with id where you want your map to be-->

<div id="mapid"></div>


<script>

    var pgroutingdata;
    var coordinates;
    var nongeo;
    var adressedata;
    var geojsonphp;
    var adress;
    var agedata;
    var rode_nr = 36;
    var traindata;
    var educationData;
    var blackMarker = new L.AwesomeMarkers.icon({
        icon: 'home',
        prefix: 'fa',
        markerColor: 'black',
    });
    var blueMarker = new L.AwesomeMarkers.icon({
        icon: 'train',
        prefix: 'fa',
        markerColor: 'blue',
    });

    //initialize the map and set its view to chosen geographical coordinates and zoom level
    var mymap = L.map('mapid').setView([55.676, 12.568], 12);
    var layerGroup = L.layerGroup(); //adds markers and geojson datapoints to a group
    layerGroup.addTo(mymap); //
    //load a tile layer Mapbox Streets tile layer
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery � <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        id:'clarineo.23o81n9e',
        accessToken:'pk.eyJ1IjoiY2xhcmluZW8iLCJhIjoiY2l2aDJocjZ0MDA1ajJvb3djeTdidWxyaSJ9.HVE2DplZgfv5T4FSUqah7A'
    }).addTo(mymap);

    var sidebar = L.control.sidebar('sidebar', {position: 'right'}).addTo(mymap);

        //Autocomplete search function
    $('#adgangsadresse-autocomplete').dawaautocomplete({
        baseUrl: 'http://dawa.aws.dk',
        minLength: 1,
        adgangsadresserOnly: true,
        params: {kommunekode: 101},
        // This function is called when the user chooses an address.
        select: function(event, input) {
            adress = input.tekst;
            console.log(input);

        },
        // This function is called upon if an error occurs: NOTE, NO FUNCTION AT THE MOMENT!
        error: function(xhr, status, error) {

        }
    });
        //This function runs the "sqlfunction" below if a user presses Enter, and only the enter button, in the address input box.
    var runsqlfunction = document.getElementById("adgangsadresse-autocomplete");
    runsqlfunction.addEventListener("keydown", function (enter) {
        if (enter.keyCode === 13) {
            validate(enter);
        }
    });
    function validate(enter) {sqlfunction()};

    //SQL funcion that runs the all the $.getJSON functions inside a $.when that executes the function that shows the data
    //when all the $.getJSON's has run.
    function sqlfunction() {
        layerGroup.clearLayers();
        //getJSON - adress being the variable for thr SQL that gets inserted in the PHP document we call.
        // getJSON function that communicates with the PHP file(s) we created
        // And "adress" being the variable (street name, house number, postal code and postal name) for the SQL that gets sent to the the PHP document we call.
        $.when($.getJSON('php/Adressgetjson.php?adresse=' + adress, function (msg) {
                console.log(msg);
                adressedata = msg;
                //alert(msg);
                var geojsonphp3 = new L.GeoJSON(msg, {
                    pointToLayer: function(feature, latlng) {
                      return L.marker(latlng, {
                          icon: blackMarker
                      });
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("<strong>" + feature.properties.adresse + "</strong><br/>")
                    }
                });
                layerGroup.addLayer(geojsonphp3);
                mymap.setView(new L.LatLng(msg.features["0"].geometry.coordinates["1"], msg.features["0"].geometry.coordinates["0"] +0.01), 14, {animation: true});
                updateSocioData()

            }),

            //get the name and geometry of the rode that intersects with the address chosen.
            $.getJSON('php/age.php?adresse=' + adress, function (data) {

                agedata = data;
                console.log(agedata);
                //alert(msg);
                var geojsonphp4 = new L.GeoJSON(data, {
                    style: function(feature){
                        return { color: "#ff0000", weight: 2, fillColor: "#ff4444", fillOpacity: 0 }
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("<strong>" + feature.properties.rodenavn + "</strong><br/>")
                    }
                });
                layerGroup.addLayer(geojsonphp4);

            }),
            //Get the geometry of parks within a 500m radius.
            $.getJSON('php/park.php?adresse=' + adress, function (park) {

                parkdata = park;
                console.log(parkdata);
                //alert(msg);
                var geojsonphp4 = new L.GeoJSON(park, {
                    style: function(feature){
                        return { color: "#009933", weight: 1, fillColor: "#009933", fillOpacity: .3 }
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("<strong>" + feature.properties.adresse + "</strong><br/>")
                    }
                });
        layerGroup.addLayer(geojsonphp4);

    }),

            //Get and display the nearest train station + related data.
            $.getJSON('php/train.php?adresse=' + adress, function (train) {

                traindata = train;
                console.log(traindata);
                var geojsonphp5 = new L.GeoJSON(train, {
                    pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: blueMarker
                        });
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("<strong>" + feature.properties.navn + ' ' + feature.properties.objekt_typ + "</strong><br/>")
                    }
                });
                layerGroup.addLayer(geojsonphp5);
            }),

            $.getJSON('php/area.php?adresse=' + adress, function (data2) {

                nongeo = data2;
                console.log(data2);
                console.log("Succesfull SQL load")

            }),
           // Get the education data from the database for the chart
            $.getJSON('php/education.php?adresse=' + adress, function(data6) {
                educationData = data6.data
                console.log(educationData);
        //Create chart to be displayed in chartContainer
        var chart2 = new CanvasJS.Chart("chartContainer2", {
            theme: "theme6",
            animationEnabled: true,
            width:300,
            title: {
                text: "Education groups %"
            },
            data: [
                {
                    type: "column",
                    dataPoints: educationData
                }
            ]
        });
        chart2.render();
      })
        ).then(showdata, failfunction)
    };

    function failfunction() {console.log("SQL load failed")}

    //Display information function (getElementByID is a test function that displays the chosen address on tab 1)
    function showdata(){document.getElementById("showdata").innerHTML = adressedata.features["0"].properties.adresse,
        //Display information relating to parks
        document.getElementById("showdata3").innerHTML = 'area of parkland within 500m: ' + nongeo["0"].sqm + ' &#13217;',
        //Display Information relating to public transportation.
        document.getElementById("showdata4").innerHTML = 'The closest train or metro station is ' + traindata.features["0"].properties.navn + ' ' + traindata.features["0"].properties.objekt_typ + '.',
        document.getElementById("showdata5").innerHTML = 'Distance: ' + traindata.features["0"].properties.distancemeter +' metres.'
    };


    // Get the socio data from the database
    var socioData;
    function updateSocioData() {$.getJSON('socio.php?adresse=' + adress, function(data5) {
        socioData = data5.data
        console.log(socioData);
        //Create chart to be displayed in chartContainer
        var chart = new CanvasJS.Chart("chartContainer", {
            theme: "theme2",
            animationEnabled: true,
            width:300,
            title: {
                text: "age groups %"
            },
            data: [
                {
                    type: "column",
                    dataPoints: socioData
                }
            ]
        });
        chart.render();
      }).then(showdata, failfunction)

  };

    function failfunction() {console.log(".Then function/SQL load failed")}

    //Display information function that shows data in the HTML sidebar using the document.getElementByID and a new jquery .when function..
    function showdata(){$.when(
        console.log(".Then function launched/Succesfull SQL load"),
        document.getElementById("showdata").innerHTML = adressedata.features["0"].properties.adresse,
        //Display information relating to parks
        document.getElementById("showdata3").innerHTML = 'area of parkland within 500m: ' + nongeo["0"].sqm + ' &#13217;',
        //Display name and type of train station/metro - possible future things relating to public transportation.
        document.getElementById("showdata4").innerHTML = 'The closest train or metro station is ' + traindata.features["0"].properties.navn + ' ' + traindata.features["0"].properties.objekt_typ + '.',
        document.getElementById("showdata5").innerHTML = 'Distance: ' + traindata.features["0"].properties.distancemeter + ' metres.',

        //Gathers the needed coordinates for pg_routing in a variable so it can be send to a PHP script.
        coordinates = adressedata.features["0"].geometry.coordinates["0"] + ',' +
                        adressedata.features["0"].geometry.coordinates["1"] + ',' +
                        traindata.features["0"].geometry.coordinates["0"],
        console.log(coordinates)

      //.then function that runs either "pgrouting" on success or "failpgrouting" if the function showdata does not run properly
    ).then(pgrouting, failpgrouting)

    };

    function failpgrouting() {console.log(".Then function/Showsdata failed")}

    //Runs the PG_routing (pgr_fromAtoB), by sending the coordinates to the pgrouting.php script.
    function pgrouting() {
            console.log("Pgrouting function launched"),
            $.getJSON('php/pgrouting.php?coordinates=' + coordinates, function (data7) {
            pgroutingdata = data7;
            console.log(data7);

            //Iteration function that summarizes the length values of the returned ways by parsing them to floats (send
            // as strings by the php script) and adding them together into the sumdistance variable.
            var sumdistance = 0,
            features = pgroutingdata.features,
            i;
            for (i = 0; i < features.length; i++) { //loop through array
            sumdistance += parseFloat(features[i].properties.cost);
            }
            //Display result of iterating function to sidebar using Math.round to remove comma values and make it readable.
            document.getElementById("showdata5").innerHTML = 'Distance: ' + Math.round(sumdistance) +' metres.';
            console.log(sumdistance);

                //Display pg_routing result to map.
                var pgrouting2leaflet = new L.GeoJSON(data7, {
                    style: function(feature){
                        return { color: "#000000", weight: 1, fillColor: "#009933", fillOpacity: .3 }
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("<strong>" + data7.features["0"].properties.name + "</strong><br/>")
                    }
                }).addTo(mymap);

        }
    )};



</script>
</body>
</html>

